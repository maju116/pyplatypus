
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.0">
    
    
      
        <title>Examples - PyPlatypus Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2e8b5541.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-data" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PyPlatypus Docs" class="md-header__button md-logo" aria-label="PyPlatypus Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyPlatypus Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Examples
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PyPlatypus Docs" class="md-nav__button md-logo" aria-label="PyPlatypus Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PyPlatypus Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome!
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../authors/" class="md-nav__link">
        The Creators
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../platypus_input/" class="md-nav__link">
        Platypus Input
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../platypus_engine/" class="md-nav__link">
        Platypus Engine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../explanation/" class="md-nav__link">
        But why?
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Examples
      </a>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="the-data">The data</h1>
<p>This notebook aims at presenting the process of creating the end-to-end modelling pipeline with the use of <a href="https://github.com/maju116/pyplatypus">PyPlatypus</a> package.</p>
<p>As starting point, the data is crucial, let's proceed with gathering it hence. We will be working with the nuclei-related images of which the <a href="https://www.kaggle.com/c/data-science-bowl-2018/data">2018 Data Science Bowl dataset</a> is composed. These are PNG files organized in accordance with the following structure:</p>
<p>stage1_data</p>
<p>----|image_name</p>
<p>--------|images</p>
<p>------------|image.png</p>
<p>--------|masks</p>
<p>------------|mask1.png</p>
<p>------------|mask2.png</p>
<p>In the "images" folder you will find an image of shape (256, 256, 4) with the values varying from 0 to 1, while the masks are just (256, 256) matrices with the values coming from the discrete set: {0, 1}.</p>
<h1 id="the-preparation">The preparation</h1>
<p>After downloading the data, unpack it and move to any preferred destination. For this example we will be interested only in stage1_train and stage1_test subdirectories, thus other files could be put aside. Let's take a look at the exemplary image.</p>
<pre><code class="language-python">from pathlib import Path
import os
cwd = Path.cwd()
while cwd.stem != &quot;pyplatypus&quot;:
    cwd = cwd.parent
os.chdir(cwd)
</code></pre>
<pre><code class="language-python"># 20% for validation
data_path = Path(&quot;examples/data/data_science_bowl/&quot;)
models_path = Path(&quot;examples/models/&quot;)

example = &quot;0a7d30b252359a10fd298b638b90cb9ada3acced4e0c0e5a3692013f432ee4e9&quot;
train_image = os.listdir(data_path/Path(f&quot;stage1_train/{example}/images&quot;), )
train_masks = os.listdir(data_path/Path(f&quot;stage1_train/{example}/masks&quot;))
</code></pre>
<pre><code class="language-python">from matplotlib import pyplot as plt
# Load the image along with on of the masks associated
example_image = plt.imread(data_path/Path(f&quot;stage1_train/{example}/images/{train_image[0]}&quot;))
example_mask1 = plt.imread(data_path/Path(f&quot;stage1_train/{example}/masks/{train_masks[0]}&quot;))
example_mask2 = plt.imread(data_path/Path(f&quot;stage1_train/{example}/masks/{train_masks[2]}&quot;))
</code></pre>
<pre><code class="language-python">plt.figure()
plt.imshow(example_image, alpha=0.6)
plt.imshow(example_mask1, alpha=0.2)
plt.imshow(example_mask2, alpha=0.2)
plt.title(&quot;Original image with the masks in yellow.&quot;)
</code></pre>
<pre><code>Text(0.5, 1.0, 'Original image with the masks in yellow.')
</code></pre>
<p><img alt="png" src="../output_5_1.png" /></p>
<p>What you see as the yellow area is the "Segmentation mask" which is simply telling us which pixel belongs to which class. Assesing this membership is the goal that we are striving to achieve.</p>
<h1 id="splitting-the-data">Splitting the data</h1>
<p>For the modeling, beside train and test sets, we will need a validation set for it is common good practice to have one.
Feel free to use the following script but beware, it will move a sample set of images from yout stage1_train folder to the stage1_validation.</p>
<pre><code class="language-python">from glob import glob
from random import sample
from shutil import move

def create_validation_set(data_path, p=0.2):
    train_images = glob(str(data_path/Path(&quot;stage1_train/*&quot;)))
    # Validation set size (as percentage)
    p = 0.2
    validation_images = sample(train_images, round(p*len(train_images)))
    Path.mkdir(data_path/Path(&quot;stage1_validation&quot;))
    for img_path in validation_images:
        trimmed_path = Path(img_path).stem
        move(img_path, str(data_path/Path(f&quot;stage1_validation/{trimmed_path}&quot;)))
</code></pre>
<p>Let's now inspect the input message that we are to send to PlatypusSolver in order to run it.</p>
<pre><code class="language-python">import yaml
import json
with open(r&quot;examples/data_science_bowl_config.yaml&quot;) as stream:
    config = yaml.safe_load(stream)
    print(json.dumps(config, indent=4, sort_keys=True))
</code></pre>
<pre><code>{
    "augmentation": {
        "Blur": {
            "always_apply": false,
            "blur_limit": 7,
            "p": 0.5
        },
        "Flip": {
            "always_apply": false,
            "p": 0.5
        },
        "RandomRotate90": {
            "always_apply": false,
            "p": 0.5
        },
        "ToFloat": {
            "always_apply": true,
            "max_value": 255,
            "p": 1.0
        }
    },
    "object_detection": null,
    "semantic_segmentation": {
        "data": {
            "colormap": [
                [
                    0,
                    0,
                    0
                ],
                [
                    1,
                    1,
                    1
                ]
            ],
            "column_sep": ";",
            "loss": "focal loss",
            "metrics": [
                "tversky coefficient",
                "iou coefficient"
            ],
            "mode": "nested_dirs",
            "optimizer": "adam",
            "shuffle": false,
            "subdirs": [
                "images",
                "masks"
            ],
            "test_path": "examples/data/data_science_bowl/stage1_test",
            "train_path": "examples/data/data_science_bowl/stage1_train",
            "validation_path": "examples/data/data_science_bowl/stage1_validation"
        },
        "models": [
            {
                "activation_layer": "relu",
                "batch_normalization": true,
                "batch_size": 32,
                "blocks": 4,
                "deep_supervision": false,
                "dropout": 0.2,
                "epochs": 100,
                "filters": 16,
                "grayscale": false,
                "h_splits": 0,
                "kernel_initializer": "he_normal",
                "linknet": false,
                "n_class": 2,
                "name": "res_u_net",
                "net_h": 256,
                "net_w": 256,
                "plus_plus": false,
                "resunet": true,
                "u_net_conv_block_width": 4,
                "use_separable_conv2d": true,
                "use_spatial_droput2d": true,
                "use_up_sampling2d": false,
                "w_splits": 0
            },
            {
                "batch_normalization": true,
                "batch_size": 8,
                "blocks": 2,
                "deep_supervision": true,
                "dropout": 0.2,
                "epochs": 5,
                "filters": 16,
                "grayscale": false,
                "h_splits": 0,
                "kernel_initializer": "he_normal",
                "linknet": false,
                "n_class": 2,
                "name": "u_net_plus_plus",
                "net_h": 256,
                "net_w": 256,
                "plus_plus": true,
                "use_separable_conv2d": true,
                "use_spatial_dropout2d": true,
                "use_up_sampling2d": true,
                "w_splits": 0
            }
        ]
    }
}
</code></pre>
<p>What might have struck you is that the config is organized so that it might potentially tell the Solver to train multiple models while using a complex augmentation pipeline and loss functions coming from the rather large set of ones available within the PyPlatypus framework.</p>
<p><img alt="68747470733a2f2f69322e77702e636f6d2f6e657074756e652e61692f77702d636f6e74656e742f75706c6f6164732f552d6e65742d6172636869746563747572652e706e673f73736c3d31.webp" src="../u_net.png" /></p>
<h1 id="the-model">The model</h1>
<p>The models present in the PyPlatypus segmentation submodule are U-Net based.</p>
<p>U-Net was originally developed for biomedical data segmentation. As you can see in the picture above architecture is very similar to autoencoder and it looks like the letter U, hence the name. Model is composed of 2 parts, and each part has some number of convolutional blocks (3 in the image above). Number of blocks will be hyperparameter in our model.</p>
<p>To build a U-Net model in platypus use u_net function. You have to specify:</p>
<ul>
<li>Number of convolutional blocks,</li>
<li>Input image height and width - it need not to be in the form 2^N, as we added the generalizng layer.</li>
<li>Indicator determining if the input image will be loaded as grayscale or RGB.</li>
<li>Number of classes - in our case we have only 2 (background and nuclei).</li>
<li>Additional arguments for CNN such as: number of filters, dropout rate etc.</li>
</ul>
<p>Hereafter the models' building process is rather straightforward.</p>
<pre><code class="language-python">from platypus.solvers.platypus_cv_solver import PlatypusSolver


ps = PlatypusSolver(
    config_yaml_path=Path(&quot;examples/data_science_bowl_config.yaml&quot;)
)
ps.train()
</code></pre>
<pre><code>WARNING:root:The current image 1f9e429c12f4477221b5b855a5f494fda2ef6d064ff75b061ffaf093e91758c5 is incomplete for it contains only masks or images!


445 images detected!
Set 'steps_per_epoch' to: 14
112 images detected!
Set 'steps_per_epoch' to: 4
112 images detected!
Set 'steps_per_epoch' to: 4
14/14 [==============================] - 101s 7s/step - loss: 0.1199 - categorical_crossentropy: 0.5762 - tversky_coefficient: 0.4767 - iou_coefficient: 0.3130 - val_loss: 0.1058 - val_categorical_crossentropy: 0.5702 - val_tversky_coefficient: 0.4876 - val_iou_coefficient: 0.3225


WARNING:root:The current image 1f9e429c12f4477221b5b855a5f494fda2ef6d064ff75b061ffaf093e91758c5 is incomplete for it contains only masks or images!


445 images detected!
Set 'steps_per_epoch' to: 56
112 images detected!
Set 'steps_per_epoch' to: 14
112 images detected!
Set 'steps_per_epoch' to: 14
56/56 [==============================] - 90s 2s/step - loss: 0.0642 - iou_coefficient: 0.3874 - categorical_crossentropy: 0.4394 - tversky_coefficient: 0.5567 - val_loss: 0.0784 - val_iou_coefficient: 0.3544 - val_categorical_crossentropy: 0.5074 - val_tversky_coefficient: 0.5233
</code></pre>
<h1 id="predictions">Predictions</h1>
<p>Only after do we train the models, we can easily produce predicted masks based on the validation set or whatever data that we would like to use, just make sure it is organized as in the train/validation/test sets.</p>
<pre><code class="language-python">from glob import glob
from random import sample
from PIL import Image
import numpy as np

def sample_and_plot_predictions(data_path: Path, model_name: str, n=3):
    validation_images = glob(str(data_path/Path(&quot;stage1_validation/*&quot;)))
    # Sample size
    n_max = len(validation_images)
    n=n_max if n &gt; n_max else n
    validation_images = sample(validation_images, n)
    for img_path in validation_images:
        img_name = img_path.split(&quot;/&quot;)[-1:][0]
        img = glob(f&quot;{img_path}/images/*.png&quot;)[0]
        predictions = glob(f&quot;{img_path}/predicted_masks/{model_name}_predicted_mask.png&quot;)[0]
        # Load images
        img_loaded = Image.open(img) 
        predictions_loaded = Image.open(predictions)
        original_size_scaled = (np.array(img_loaded.size)/2).astype(int)
        predictions_scaled = predictions_loaded.resize(original_size_scaled)
        # Plot image and predicted masks
        f, axarr = plt.subplots(1,2)
        plt.title(f&quot;Image and predictions: {img_name}&quot;)
        axarr[0].imshow(img_loaded)
        axarr[1].imshow(predictions_scaled)
</code></pre>
<pre><code class="language-python"># Clean the results of former runs
from glob import glob
from shutil import rmtree
masks = glob(str(data_path/&quot;stage1_validation/**/predicted_*&quot;))
for mask in masks:
    rmtree(mask)

</code></pre>
<pre><code class="language-python"># When the custom_data_path is set to None, the validation data will be used.
# If that is not the intention of yours, feel free to point the engine to any other direction.
ps.produce_and_save_predicted_masks_for_model(model_name=&quot;u_net_plus_plus&quot;, custom_data_path=None)
</code></pre>
<pre><code>1/1 [==============================] - 1s 742ms/step
1/1 [==============================] - 0s 442ms/step
1/1 [==============================] - 0s 331ms/step
1/1 [==============================] - 0s 355ms/step
1/1 [==============================] - 0s 318ms/step
1/1 [==============================] - 0s 310ms/step
1/1 [==============================] - 0s 313ms/step
1/1 [==============================] - 0s 430ms/step
1/1 [==============================] - 0s 316ms/step
1/1 [==============================] - 0s 309ms/step
1/1 [==============================] - 0s 311ms/step
1/1 [==============================] - 0s 325ms/step
1/1 [==============================] - 0s 326ms/step
1/1 [==============================] - 0s 295ms/step
</code></pre>
<pre><code class="language-python">sample_and_plot_predictions(data_path, model_name=&quot;u_net_plus_plus&quot;, n=10)
</code></pre>
<p><img alt="png" src="../output_19_0.png" /></p>
<p><img alt="png" src="../output_19_1.png" /></p>
<p><img alt="png" src="../output_19_2.png" /></p>
<p><img alt="png" src="../output_19_3.png" /></p>
<p><img alt="png" src="../output_19_4.png" /></p>
<p><img alt="png" src="../output_19_5.png" /></p>
<p><img alt="png" src="../output_19_6.png" /></p>
<p><img alt="png" src="../output_19_7.png" /></p>
<p><img alt="png" src="../output_19_8.png" /></p>
<p><img alt="png" src="../output_19_9.png" /></p>
<pre><code class="language-python">ps.produce_and_save_predicted_masks_for_model(model_name=&quot;res_u_net&quot;, custom_data_path=None)
</code></pre>
<pre><code>1/1 [==============================] - 2s 2s/step
1/1 [==============================] - 1s 1s/step
1/1 [==============================] - 1s 1s/step
1/1 [==============================] - 1s 1s/step
</code></pre>
<pre><code class="language-python">sample_and_plot_predictions(data_path, model_name=&quot;u_net_plus_plus&quot;, n=10)
</code></pre>
<p><img alt="png" src="../output_21_0.png" /></p>
<p><img alt="png" src="../output_21_1.png" /></p>
<p><img alt="png" src="../output_21_2.png" /></p>
<p><img alt="png" src="../output_21_3.png" /></p>
<p><img alt="png" src="../output_21_4.png" /></p>
<p><img alt="png" src="../output_21_5.png" /></p>
<p><img alt="png" src="../output_21_6.png" /></p>
<p><img alt="png" src="../output_21_7.png" /></p>
<p><img alt="png" src="../output_21_8.png" /></p>
<p><img alt="png" src="../output_21_9.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../explanation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: But why?" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              But why?
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.48f2be22.min.js"></script>
      
    
  </body>
</html>